<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trading Checklist</title>

<style>
  :root{
    --bg:#191919;
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.62);

    --panelStroke:rgba(255,255,255,.08);

    --radius:16px;
    --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }

  *{ box-sizing:border-box; }

  html,body{
    margin:0;padding:0;height:100%;
    background:var(--bg)!important;
  }

  body{
    color:var(--text);
    font-family:var(--sans);
    padding:8px;
  }

  .wrap{ width:100%; margin:0 auto; }

  .panel{
    background:var(--bg);
    border:1px solid var(--panelStroke);
    border-radius:var(--radius);
    overflow:hidden;
  }

  .header{
    display:flex;
    justify-content:center;
    align-items:center;
    padding:8px;
    border-bottom:1px solid rgba(255,255,255,.07);
  }

  .chip{
    font-family:var(--mono);
    font-size:11px;
    color:rgba(255,255,255,.88);
    padding:6px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.22);
    white-space:nowrap;
    min-width:160px;
    text-align:center;
  }

  .content{ padding:8px; }

  /* --- TOP SELECTOR PILLS --- */
  .selector{
    display:grid;
    gap:8px;
    margin-bottom:8px;
    grid-template-columns: repeat(4, minmax(0,1fr));
  }

  @media (max-width: 520px){
    .selector{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }

  .selBtn{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.12);
    color:rgba(255,255,255,.88);
    cursor:pointer;
    text-align:left;
    min-width:0;
    transition: box-shadow 200ms ease, border-color 200ms ease;
  }

  .selLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .selDot{
    width:10px;height:10px;border-radius:50%;
    box-shadow:0 0 0 4px rgba(255,255,255,.08);
    flex:0 0 auto;
  }

  .selName{
    font-family:var(--mono);
    font-size:11px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .selCount{
    font-family:var(--mono);
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    color:rgba(255,255,255,.75);
    white-space:nowrap;
    flex:0 0 auto;
  }

  /* ACTIVE outline size stays EXACTLY as you like. */
  .selBtn.active{
    border-color: rgba(255,255,255,.14);
    box-shadow: 0 0 0 2px var(--glow, rgba(255,255,255,.08));
  }

  /* One-time smooth grow (no loop) */
  .selBtn.animIn{
    animation: outlinePop 280ms ease-out 1;
  }
  @keyframes outlinePop{
    0%   { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    100% { box-shadow: 0 0 0 2px var(--glow, rgba(255,255,255,.08)); }
  }

  /* --- MAIN GROUP CARD --- */
  .group{
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    overflow:hidden;
    background:rgba(0,0,0,.12);
  }

  .groupHead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-bottom:none; /* keep clean */
  }

  .headLeft{
    display:flex;
    align-items:flex-start;
    gap:10px;
    min-width:0;
  }

  .badgeDot{
    width:10px;height:10px;border-radius:50%;
    margin-top:2px;
    box-shadow:0 0 0 4px rgba(255,255,255,.08);
    flex:0 0 auto;
  }

  .titleWrap{ min-width:0; }

  .groupTitle{
    font-size:12px;
    font-weight:800;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .sub{
    font-size:10px;
    color:rgba(255,255,255,.62);
    margin-top:2px;
  }

  .countPill{
    font-family:var(--mono);
    font-size:10px;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    color:rgba(255,255,255,.78);
    white-space:nowrap;
    min-width:54px;
    text-align:center;
    flex:0 0 auto;
  }

  /* small outline glow ONLY around the header */
  .group.glow .groupHead{
    box-shadow: 0 0 0 2px var(--glow, rgba(255,255,255,.08));
    border-radius:14px; /* ensures glow is clean */
  }

  /* ✅ REMOVE the “line” under the title (your arrow)
     The line was visually happening at the boundary between head and body.
     So we remove any “top edge” look by:
     - no padding-top gap
     - no background contrast edge
     - no top border
  */
  .groupBody{
    padding:10px;
    padding-top:0;              /* key: flush under title */
    border-top:none !important; /* hard kill */
    box-shadow:none !important;
    background:transparent;     /* prevents a seam */
  }

  .items{ display:flex; flex-direction:column; gap:8px; }

  .item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.10);
  }

  .itemLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .check{
    width:22px;height:22px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    display:grid;
    place-items:center;
    cursor:pointer;
    flex:0 0 auto;
    transition:transform 160ms ease,border-color 200ms ease,background 200ms ease,box-shadow 200ms ease;
  }
  .check:active{ transform:scale(.96); }

  .tick{
    width:10px;height:7px;
    border-left:2px solid transparent;
    border-bottom:2px solid transparent;
    transform:rotate(-45deg);
    opacity:0;
    transition:opacity 160ms ease;
  }

  .txt{
    font-size:11px;
    color:rgba(255,255,255,.88);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    transition:opacity 240ms ease,color 240ms ease;
  }

  .meta{
    font-family:var(--mono);
    font-size:10px;
    color:var(--muted);
    white-space:nowrap;
    flex:0 0 auto;
  }

  .done .check{
    background:rgba(40,230,165,.12);
    border-color:rgba(40,230,165,.35);
    box-shadow:0 0 0 4px rgba(40,230,165,.08);
  }
  .done .tick{
    border-left-color:rgba(40,230,165,.95);
    border-bottom-color:rgba(40,230,165,.95);
    opacity:1;
  }
  .done .txt{
    opacity:.62;
    color:rgba(255,255,255,.68);
    text-decoration:line-through;
    text-decoration-color:rgba(255,255,255,.24);
  }

  .footer{
    padding:8px 10px 10px;
    border-top:1px solid rgba(255,255,255,.07);
    display:flex;
    justify-content:flex-end;
    align-items:center;
  }

  .btn{
    font-family:var(--mono);
    font-size:10px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    color:rgba(255,255,255,.78);
    cursor:pointer;
  }

  @media (max-width: 430px){
    body{ padding:6px; }
    .content{ padding:8px; }
    .chip{ font-size:11px; padding:6px 12px; min-width:160px; }
    .selBtn{ padding:10px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div class="header">
      <div class="chip" id="topChip">ET --:-- • Checklist</div>
    </div>

    <div class="content">
      <div id="root"></div>
    </div>

    <div class="footer">
      <button class="btn" id="resetBtn" type="button">Reset</button>
    </div>
  </div>
</div>

<script>
  const TZ = "America/Toronto";

  const GROUPS = [
    {
      id: "lock",
      short: "Lock",
      color: "#FF4D6D",
      title: "NO-TRADE LOCK (POST-KILLZONE)",
      items: [{ id:"lock_on", text:"Trading locked", meta:"1" }]
    },
    {
      id: "pre",
      short: "Pre",
      color: "#3D78FF",
      title: "NY PRE-MARKET (ICT BIAS)",
      items: [
        { id:"bias", text:"Daily bias", meta:"1" },
        { id:"news", text:"High-impact news", meta:"2" },
        { id:"asia", text:"Asia + London high/low", meta:"3" },
        { id:"pd",   text:"HTF PD arrays", meta:"4" },
        { id:"one",  text:"One ICT model only", meta:"5" }
      ]
    },
    {
      id: "kz",
      short: "KZ",
      color: "#28E6A5",
      title: "NY KILLZONE TRADING",
      subtitle: "9:30 AM → 11:00 AM",
      items: [
        { id:"confirm", text:"Wait for confirmation", meta:"1" },
        { id:"entry",   text:"Execute entry", meta:"2" },
        { id:"manage",  text:"Manage trade", meta:"3" }
      ]
    },
    {
      id: "post",
      short: "Post",
      color: "#FFD34D",
      title: "ICT POST-TRADE REVIEW",
      items: [
        { id:"journal", text:"Journal setup & outcome", meta:"1" },
        { id:"ss",      text:"Chart screenshot", meta:"2" },
        { id:"emotion", text:"Emotion check", meta:"3" },
        { id:"rules",   text:"Followed ICT rules?", meta:"4" }
      ]
    }
  ];

  const root = document.getElementById("root");
  const topChip = document.getElementById("topChip");
  const resetBtn = document.getElementById("resetBtn");

  // ---- Time helpers (ET) ----
  function dtParts(tz, d=new Date()){
    const parts = new Intl.DateTimeFormat("en-GB", {
      timeZone: tz,
      hour12:false,
      weekday:"short",
      hour:"2-digit",
      minute:"2-digit"
    }).formatToParts(d);

    const get = (t)=>parts.find(p=>p.type===t)?.value;
    return { wd:get("weekday"), hh:get("hour"), mm:get("minute") };
  }

  function minsInTZ(tz){
    const p = dtParts(tz);
    return Number(p.hh)*60 + Number(p.mm);
  }

  function ymd(tz, d=new Date()){
    const parts = new Intl.DateTimeFormat("en-CA", {
      timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"
    }).formatToParts(d);
    const get = (t)=>parts.find(p=>p.type===t)?.value;
    return `${get("year")}-${get("month")}-${get("day")}`;
  }

  // Weekend (futures): Fri 6:00 PM ET → Sun 6:00 PM ET
  function isMarketWeekend(){
    const p = dtParts(TZ);
    const now = Number(p.hh)*60 + Number(p.mm);
    const wd = p.wd;
    if(wd === "Sat") return true;
    if(wd === "Sun") return now < (18*60);
    if(wd === "Fri") return now >= (18*60);
    return false;
  }

  // Auto selection windows (ET)
  function autoGroupId(){
    const now = minsInTZ(TZ);
    const t0830 = 8*60 + 30;
    const t0930 = 9*60 + 30;
    const t1100 = 11*60;
    const t2000 = 20*60;

    if(now >= t2000 || now < t0830) return "lock";
    if(now >= t0830 && now < t0930) return "pre";
    if(now >= t0930 && now < t1100) return "kz";
    return "post";
  }

  // ---- Storage (localStorage) ----
  function canUseLocalStorage(){
    try{
      const k="__t"; localStorage.setItem(k,"1"); localStorage.removeItem(k);
      return true;
    }catch{ return false; }
  }
  const LS_OK = canUseLocalStorage();

  function storeGet(key, fallback){
    if(!LS_OK) return fallback;
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch{ return fallback; }
  }
  function storeSet(key, val){
    if(!LS_OK) return;
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
  }
  function storeDel(key){
    if(!LS_OK) return;
    try{ localStorage.removeItem(key); }catch{}
  }

  const stampKey = "chk_last_seen_day_et";
  function dayKey(){ return `chk_day_${ymd(TZ)}`; }
  function uiKey(){ return `chk_ui_${ymd(TZ)}`; }

  function ensureDailyReset(){
    const today = ymd(TZ);
    const last = storeGet(stampKey, null);
    if(last !== today){
      storeSet(stampKey, today);
    }
  }

  function loadState(){ return storeGet(dayKey(), {}); }
  function saveState(state){ storeSet(dayKey(), state); }

  // UI: selected + lastAuto + userOverrideUntil
  function loadUI(){ return storeGet(uiKey(), { selected: null, lastAuto: null, userOverrideUntil: 0 }); }
  function saveUI(ui){ storeSet(uiKey(), ui); }

  function hexToGlow(hex){
    const c = hex.replace("#","").trim();
    const r = parseInt(c.substring(0,2),16);
    const g = parseInt(c.substring(2,4),16);
    const b = parseInt(c.substring(4,6),16);
    return `rgba(${r},${g},${b},.18)`;
  }

  function countDone(state, group){
    let d=0;
    for(const it of group.items) if(state[it.id]) d++;
    return d;
  }

  function renderWeekend(){
    const p = dtParts(TZ);
    topChip.textContent = `ET ${p.hh}:${p.mm} • Weekend`;

    const card = document.createElement("div");
    card.style.border = "1px solid rgba(255,255,255,.10)";
    card.style.borderRadius = "14px";
    card.style.padding = "12px";
    card.style.background = "rgba(255,255,255,.05)";

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
        <div>
          <div style="font-weight:800;font-size:12px;letter-spacing:.2px;">Weekend Review</div>
          <div style="margin-top:4px;color:rgba(255,255,255,.62);font-size:10px;">Plan + improve for next week</div>
        </div>
        <div class="countPill">OFF</div>
      </div>
      <div style="margin-top:10px;color:rgba(255,255,255,.78);font-size:11px;line-height:1.35;">
        • 1 best trade + why it worked<br/>
        • 1 biggest mistake + fix rule<br/>
        • Backtest goal (20 charts)
      </div>
    `;

    root.innerHTML = "";
    root.appendChild(card);
  }

  function setActiveAnim(btn){
    // one-time animation each time selection changes
    btn.classList.remove("animIn");
    void btn.offsetWidth;
    btn.classList.add("animIn");
  }

  function renderWeekday(){
    const p = dtParts(TZ);
    topChip.textContent = `ET ${p.hh}:${p.mm} • Checklist`;

    const state = loadState();
    const ui = loadUI();

    const auto = autoGroupId();
    const nowMs = Date.now();

    let selected = ui.selected;

    // If no selection OR auto changed and no recent manual override → auto switch
    if(!selected){
      selected = auto;
      ui.selected = auto;
      ui.lastAuto = auto;
      saveUI(ui);
    }else{
      const autoChanged = (ui.lastAuto !== auto);
      const allowAuto = nowMs > (ui.userOverrideUntil || 0);
      if(autoChanged && allowAuto){
        selected = auto;
        ui.selected = auto;
        ui.lastAuto = auto;
        saveUI(ui);
      }else{
        // keep lastAuto updated even if user is overriding
        ui.lastAuto = auto;
        saveUI(ui);
      }
    }

    const wrap = document.createElement("div");

    const selector = document.createElement("div");
    selector.className = "selector";

    let activeBtnRef = null;

    for(const g of GROUPS){
      const done = countDone(state, g);
      const total = g.items.length;

      const b = document.createElement("button");
      b.type = "button";
      b.className = "selBtn" + (g.id === selected ? " active" : "");
      b.style.setProperty("--glow", hexToGlow(g.color));

      b.innerHTML = `
        <div class="selLeft">
          <div class="selDot" style="background:${g.color};box-shadow:0 0 0 4px ${hexToGlow(g.color)}"></div>
          <div class="selName">${g.short}</div>
        </div>
        <div class="selCount">${done}/${total}</div>
      `;

      if(g.id === selected) activeBtnRef = b;

      b.addEventListener("click", () => {
        const ui2 = loadUI();
        ui2.selected = g.id;
        // Give user a short “manual override” window so it doesn’t instantly auto-switch
        ui2.userOverrideUntil = Date.now() + 2 * 60 * 1000; // 2 minutes
        saveUI(ui2);
        render();
      });

      selector.appendChild(b);
    }

    const gSel = GROUPS.find(x=>x.id===selected) || GROUPS[0];
    const doneSel = countDone(state, gSel);

    const card = document.createElement("div");
    card.className = "group glow";
    card.style.setProperty("--glow", hexToGlow(gSel.color));

    card.innerHTML = `
      <div class="groupHead">
        <div class="headLeft">
          <div class="badgeDot" style="background:${gSel.color};box-shadow:0 0 0 4px ${hexToGlow(gSel.color)}"></div>
          <div class="titleWrap">
            <div class="groupTitle">${gSel.title}</div>
            ${gSel.subtitle ? `<div class="sub">${gSel.subtitle}</div>` : ``}
          </div>
        </div>
        <div class="countPill">${doneSel}/${gSel.items.length}</div>
      </div>
      <div class="groupBody">
        <div class="items" id="items"></div>
      </div>
    `;

    const itemsEl = card.querySelector("#items");

    for(const it of gSel.items){
      const row = document.createElement("div");
      row.className = "item" + (state[it.id] ? " done" : "");
      row.innerHTML = `
        <div class="itemLeft">
          <button class="check" type="button" aria-label="Toggle">
            <span class="tick"></span>
          </button>
          <div class="txt"></div>
        </div>
        <div class="meta">${it.meta || ""}</div>
      `;
      row.querySelector(".txt").textContent = it.text;

      row.querySelector(".check").addEventListener("click", () => {
        state[it.id] = !state[it.id];
        saveState(state);
        render();
      });

      itemsEl.appendChild(row);
    }

    wrap.appendChild(selector);
    wrap.appendChild(card);

    root.innerHTML = "";
    root.appendChild(wrap);

    // ✅ apply one-time smooth grow to the active pill
    if(activeBtnRef) setActiveAnim(activeBtnRef);
  }

  function render(){
    ensureDailyReset();

    if(isMarketWeekend()){
      renderWeekend();
      return;
    }
    renderWeekday();
  }

  resetBtn.addEventListener("click", () => {
    storeDel(dayKey());
    storeDel(uiKey());
    render();
  });

  // Initial render
  render();

  // Keep auto switch + weekend boundaries updated
  setInterval(render, 15000);
</script>
</body>
</html>